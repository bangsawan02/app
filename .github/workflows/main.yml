# .github/workflows/android_build.yml

name: Android CI Build (Upgrade Gradle & Build)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 
    
    env:
      PROJECT_FOLDER: float 
      GRADLE_TARGET_VERSION: 8.6 # ⭐ Versi Gradle yang ingin di-sync

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} 
          
      # [Cache Gradle Dependencies tetap di sini]
      # ...

      - name: Set up JDK 17 with Gradle Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"
          GRADLE_USER_HOME: ${{ runner.temp }}/.gradle
          
      # ⭐ LANGKAH BARU: UPGRADE DAN PUSH JIKA PERLU
      - name: Upgrade Gradle Wrapper to 8.6
        id: wrapper_upgrade
        # Jalankan hanya jika folder proyek sudah ada di repositori
        if: always() # Jalankan selalu, meskipun ada error di langkah sebelumnya
        run: |
          PROJECT_DIR="${{ env.PROJECT_FOLDER }}"
          GRADLE_VER="${{ env.GRADLE_TARGET_VERSION }}"
          
          # Cek: Apakah folder proyek (float) sudah ada?
          if [ -d "${PROJECT_DIR}" ]; then
            echo "--- Folder proyek ditemukan. Melakukan pengecekan versi Gradle... ---"
            
            # 1. Beri izin eksekusi pada wrapper yang lama (jika ada)
            chmod +x "${PROJECT_DIR}/gradlew"
            
            # 2. Jalankan command upgrade wrapper
            # -w: menjalankan tugas dari root folder project
            ./"${PROJECT_DIR}/gradlew" wrapper --gradle-version ${GRADLE_VER} --no-daemon
            
            # Cek apakah ada perubahan pada file wrapper
            if ! git diff --exit-code "${PROJECT_DIR}/gradle/wrapper/gradle-wrapper.properties"; then
              echo "needs_push=true" >> $GITHUB_OUTPUT
              echo "--- Wrapper berhasil di-upgrade! Perlu push. ---"
            else
              echo "needs_push=false" >> $GITHUB_OUTPUT
              echo "--- Wrapper sudah versi terbaru. Tidak ada perubahan. ---"
            fi
            
          else
            echo "--- Folder proyek belum di-setup di repo. Lakukan setup manual/ekstraksi ZIP dulu. ---"
            # Dalam skenario ini, kita anggap proyek harus sudah ada di repo (tidak lagi dari ZIP)
            exit 1 # Gagal jika proyek belum di-setup
          fi

      # ... (Langkah-langkah selanjutnya tetap sama) ...
      
      # 3. Persiapan Build
      - name: Grant Execute Permission to gradlew
        run: chmod +x gradlew
        working-directory: ${{ env.PROJECT_FOLDER }}
        
      - name: Clean Project and Dependencies
        run: ./gradlew clean --refresh-dependencies
        working-directory: ${{ env.PROJECT_FOLDER }}

      # 4. Proses Build
      - name: Build Debug APK with Gradle
        run: ./gradlew assembleDebug -Dorg.gradle.parallel=true
        working-directory: ${{ env.PROJECT_FOLDER }}
          
      # 5. Commit dan Push Perubahan
      - name: Commit and Push Updated Wrapper Files
        # Hanya jalankan jika output dari langkah 'wrapper_upgrade' adalah true
        if: steps.wrapper_upgrade.outputs.needs_push == 'true'
        run: |
          echo "Melakukan commit dan push file wrapper yang sudah diperbarui..."
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Tambahkan hanya file wrapper yang berubah
          git add ${{ env.PROJECT_FOLDER }}/gradle/wrapper/gradle-wrapper.properties
          git add ${{ env.PROJECT_FOLDER }}/gradle/wrapper/gradle-wrapper.jar
          
          git commit -m "CI Auto-Sync: Upgraded Gradle Wrapper to ${{ env.GRADLE_TARGET_VERSION }}"
          
          git push
