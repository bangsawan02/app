# .github/workflows/setup-gui-runner.yml

name: setup KDE Plasma + Tailscale + VNC/NoVNC

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      TAILSCALE_AUTHKEY: ${{ vars.AUTHKEY }}
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_HOSTNAME: gh-plasma-${{ github.run_id }}
      VNC_DISPLAY: ':1' # Display VNC yang akan digunakan
      VNC_PORT: 5901   # Port VNC standar (5900 + VNC_DISPLAY)
      NOVNC_PORT: 6080 # Port default NoVNC

    steps:
      - uses: actions/checkout@v4

      - name: Setup User Password
        run: |
          # Buat sandi untuk pengguna runner
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}
          
      - name: Install KDE Plasma, VNC Server, dan NoVNC
        run: |
          echo ">>> Installing Desktop & VNC components..."
          sudo apt-get update -qq
          # tightvncserver untuk server VNC, fluxbox atau xterm untuk lingkungan dasar
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq tightvncserver kde-plasma-desktop xterm websockify net-tools
          
          # Unduh dan Instal NoVNC (menggunakan websockify yang sudah diinstal)
          mkdir -p /home/${USERNAME}/novnc
          cd /home/${USERNAME}/novnc
          wget https://github.com/novnc/noVNC/archive/refs/tags/v1.3.0.tar.gz
          tar -xzvf v1.3.0.tar.gz
          mv noVNC-1.3.0 www
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/novnc
          
      - name: Configure and Start VNC Server
        run: |
          # Pindah ke home directory runner
          cd /home/${USERNAME}

          # Inisialisasi tightvncserver (membuat file sandi VNC, gunakan sandi yang sama)
          echo "${PASSWORD}" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Konfigurasi VNC untuk memulai KDE Plasma saat diakses
          mkdir -p ~/.vnc
          echo '#!/bin/sh' > ~/.vnc/xstartup
          echo 'xrdb $HOME/.Xresources' >> ~/.vnc/xstartup
          echo 'startkde' >> ~/.vnc/xstartup # Panggil KDE Plasma
          chmod +x ~/.vnc/xstartup
          
          # Start VNC Server di background
          vncserver ${VNC_DISPLAY} -geometry 1280x800 -depth 24
          
      - name: Install Tailscale dan Dapatkan IP
        run: |
          echo ">>> Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh >/dev/null 2>&1
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "${TAILSCALE_HOSTNAME}"
          
          # Simpan IP Tailscale sebagai output
          TAILSCALE_IP=$(sudo tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          
      - name: Start NoVNC and Keep Alive
        run: |
          echo "=== FINAL CONNECTION INFO ==="
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "NoVNC URL: http://${{ env.TAILSCALE_IP }}:${NOVNC_PORT}/vnc.html?host=${{ env.TAILSCALE_IP }}&port=${NOVNC_PORT}"
          echo "VNC Password: ${PASSWORD}"
          echo "WARNING: This runner will automatically terminate after ~6 hours."

          # Start NoVNC Web Server di background, meneruskan koneksi dari 6080 ke VNC 5901
          cd /home/${USERNAME}/novnc/www
          /usr/bin/websockify ${NOVNC_PORT} localhost:${VNC_PORT} > /dev/null 2>&1 &

          echo ">>> Keeping runner alive. Connect now via Android browser or WebView."
          # Tahan runner selama hampir 6 jam
          sleep 21600 || true
