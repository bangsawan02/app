name: Persistent LXDE + Tailscale

on:
  workflow_dispatch:

permissions:
  contents: write 

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      TAILSCALE_AUTHKEY: ${{ vars.AUTHKEY }}
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_HOSTNAME: gh-vnc-${{ github.run_id }}
      VNC_DISPLAY: ":1"
      VNC_PORT: 5901
      NOVNC_PORT: 6080
      CACHE_KEY_VERSION: v3
      LXDE_STARTUP_COMMAND: 'startlxde'

    steps:
      - uses: actions/checkout@v4

      - name: Restore APT Cache
        id: cache-apt-restore
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ env.CACHE_KEY_VERSION }} 

      - name: Clean up apt cache locks
        if: always()
        run: |
          sudo rm -f /var/cache/apt/archives/lock
          sudo rm -f /var/lib/apt/lists/lock
          sudo rm -rf /var/cache/apt/archives/partial
          sudo rm -rf /var/lib/apt/lists/partial
          
      - name: Grant permissions to APT cache
        if: always()
        run: |
          sudo chown -R $USERNAME:$USERNAME /var/cache/apt
          sudo chown -R $USERNAME:$USERNAME /var/lib/apt

      - name: Restore User Data Cache
        id: cache-user-restore
        uses: actions/cache@v4
        with:
          path: /home/${{ env.USERNAME }}
          key: ${{ runner.os }}-lxde-data-${{ env.CACHE_KEY_VERSION }}
          restore-keys: |
            ${{ runner.os }}-lxde-data-

      - name: Configure User (Runner)
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install LXDE, VNC, noVNC, and Setup
        run: |
          sudo apt update -qq
          sudo apt install -y -qq \
            lxde-core \
            tigervnc-standalone-server \
            dbus-x11 \
            python3-pip git net-tools \
            > /dev/null 2>&1
          
          sudo git clone https://github.com/novnc/noVNC.git /opt/noVNC
          sudo git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          sudo pip3 install websockify
          
          sudo mkdir -p /home/${USERNAME}/.vnc
          
          VNC_XSTARTUP='#!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          /usr/bin/${{ env.LXDE_STARTUP_COMMAND }}'
          
          echo "$VNC_XSTARTUP" | sudo tee /home/${USERNAME}/.vnc/xstartup
          sudo chmod +x /home/${USERNAME}/.vnc/xstartup
          
          echo "${PASSWORD}" | vncpasswd -f | sudo tee /home/${USERNAME}/.vnc/passwd
          
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc
          sudo chmod 600 /home/${USERNAME}/.vnc/passwd
          
          sudo apt clean

      - name: Save APT Cache
        uses: actions/cache@v4
        if: success()
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ env.CACHE_KEY_VERSION }}

      - name: Install and Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh >/dev/null 2>&1
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "${TAILSCALE_HOSTNAME}" --accept-routes --ssh
          sleep 5
          sudo tailscale ip -4

      - name: Start VNC Server and noVNC
        run: |
          sudo su - ${USERNAME} -c "/usr/bin/vncserver ${VNC_DISPLAY} -geometry 1280x800 -depth 24"
          
          sudo su - ${USERNAME} -c "/opt/noVNC/utils/websockify/run --web /opt/noVNC ${NOVNC_PORT} localhost:${VNC_PORT} &"

          sleep 5
          
      - name: Connection + Keep Alive
        run: |
          IP_ADDR=$(sudo tailscale ip -4)
          echo "::notice file=README.md,line=1::=== FINAL CONNECTION INFO ==="
          echo "::notice file=README.md,line=1::Desktop: LXDE (VNC/noVNC)"
          echo "::notice file=README.md,line=1::USERNAME: ${USERNAME}"
          echo "::notice file=README.md,line=1::PASSWORD: ${PASSWORD}"
          echo "::notice file=README.md,line=1::Tailscale IP: ${IP_ADDR}"
          echo "::notice file=README.md,line=1::Akses Web VNC (dari Tailnet Anda): http://${IP_ADDR}:${NOVNC_PORT}/vnc.html"
          
          echo ">>> Keeping runner alive for VNC session."
          while true; do sleep 600; done

      - name: Save User Data Cache
        uses: actions/cache@v4
        if: always()
        with:
          path: /home/${{ env.USERNAME }}
          key: ${{ runner.os }}-lxde-data-${{ env.CACHE_KEY_VERSION }}
