name: ðŸ–¥ï¸ Persistent KDE Plasma + Tailscale (Host Runner)

on:
  # Memungkinkan dijalankan secara manual dari UI GitHub
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      # Variabel Kunci, harus didefinisikan di Secrets/Vars GitHub
      TAILSCALE_AUTHKEY: ${{ vars.AUTHKEY }}
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_HOSTNAME: gh-plasma-${{ github.run_id }}
      CACHE_KEY_VERSION: v1 # Versi kustom untuk cache data

    steps:
      - uses: actions/checkout@v4

      # 1. RESTORE DATA USER
      - name: â™»ï¸ Restore User Data Cache
        id: cache-restore
        uses: actions/cache@v4
        with:
          # Direktori yang di-cache: Home Directory User Anda
          path: /home/${{ env.USERNAME }}
          # Kunci: OS + Nama Job + Versi Kustom
          key: ${{ runner.os }}-kde-data-${{ env.CACHE_KEY_VERSION }}
          restore-keys: |
            ${{ runner.os }}-kde-data-

      # 2. KONFIGURASI USER & SUDO
      - name: Ensure runner user has sudo
        run: |
          # Atur sandi untuk user runner
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          # Berikan hak NOPASSWD sudo agar instalasi non-interaktif berjalan mulus
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      # 3. INSTALASI KDE PLASMA + XRDP
      - name: Install KDE Plasma + xrdp
        run: |
          echo ">>> Installing KDE Plasma Desktop..."
          sudo apt-get update -qq
          # Instal paket KDE, Xorg, DBUS, dan XRDP
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq kde-plasma-desktop xorg dbus-x11 xrdp

          # Konfigurasi sesi KDE Plasma untuk XRDP
          echo "startplasma-x11" | sudo tee /home/${USERNAME}/.xsession
          echo "exec startplasma-x11" | sudo tee /home/${USERNAME}/.xinitrc
          # Atur kepemilikan file sesi
          sudo chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.xsession /home/${USERNAME}/.xinitrc

          # Aktifkan dan mulai ulang layanan xrdp
          sudo systemctl enable --now xrdp
          sudo systemctl restart xrdp

      # 4. INSTALASI TAILSCALE
      - name: Install Tailscale
        run: |
          echo ">>> Installing Tailscale..."
          # Instalasi menggunakan script resmi (metode yang berhasil Anda gunakan)
          curl -fsSL https://tailscale.com/install.sh | sudo sh >/dev/null 2>&1
          # Otorisasi dan sambungkan ke Tailnet
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "${TAILSCALE_HOSTNAME}"
          sudo tailscale ip -4

      # 5. KONEKSI & KEEP ALIVE
      - name: Connection + Keep Alive
        run: |
          IP_ADDR=$(sudo tailscale ip -4)
          echo "=== FINAL CONNECTION INFO ==="
          echo "USERNAME: ${USERNAME}"
          echo "PASSWORD: ${PASSWORD}"
          echo "Tailscale IP: ${IP_ADDR}"
          echo "Connect with any RDP client using the IP above."
          echo ">>> Keeping runner alive for RDP session (600 seconds interval)."
          
          # Tahan runner agar tidak selesai. Anda harus membatalkan job ini secara manual.
          while true; do sleep 600; done

      # 6. SAVE DATA USER
      - name: ðŸ’¾ Save User Data Cache
        uses: actions/cache@v4
        # Wajib: Gunakan 'always()' agar cache tersimpan saat job dibatalkan (failed)
        if: always()
        with:
          path: /home/${{ env.USERNAME }}
          key: ${{ runner.os }}-kde-data-${{ env.CACHE_KEY_VERSION }}
