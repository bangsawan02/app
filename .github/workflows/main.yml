name: üñ•Ô∏è Persistent Remote Desktop (VNC/Tailscale)

on:
  # Memungkinkan dijalankan secara manual dari UI GitHub
  workflow_dispatch:
  # Anda dapat menambahkan 'push' atau 'schedule' di sini jika diperlukan
  
jobs:
  remote-desktop-persistence:
    # Menggunakan runner Ubuntu
    runs-on: ubuntu-latest
    
    # Memberikan izin untuk menulis file (untuk caching)
    permissions:
      contents: read
      
    steps:
    
    # 1. Checkout Kode
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      
    # 2. RESTORE DOCKER VOLUME CACHE
    - name: ‚ôªÔ∏è Restore Docker Volume Cache
      id: cache-restore
      uses: actions/cache@v4
      with:
        # Menargetkan lokasi default volume Docker di Linux runner
        path: /var/lib/docker/volumes/
        
        # Kunci cache: OS + Versi Skema (v1) + Hash Dockerfile
        key: ${{ runner.os }}-docker-volume-v1-${{ hashFiles('Dockerfile') }}
        restore-keys: |
          ${{ runner.os }}-docker-volume-v1-
          ${{ runner.os }}-docker-volume-

    # 3. BUILD DAN RUN CONTAINER (VNC + Tailscale + noVNC)
    - name: üê≥ Build and Run VNC/Tailscale Container
      id: run-container
      run: |
        # Nama Volume Docker yang akan menyimpan semua data Xfce/Firefox
        VOLUME_NAME="xfce_vnc_data"
        
        # 1. Build Docker Image 
        docker build -t xfce-vnc-image .
        
        # 2. Jalankan Container. 
        # - Memetakan Volume: -v $VOLUME_NAME:/home/developer
        # - Memberikan Auth Key Tailscale sebagai Environment Variable
        docker run -d \
          --name vnc-runner \
          -v $VOLUME_NAME:/home/developer \
          -e TAILSCALE_AUTH_KEY=${{ vars.AUTHKEY }} \
          xfce-vnc-image 

        echo "Container berjalan, menunggu Tailscale koneksi..."
        # Memberikan waktu agar Tailscale melakukan koneksi dan otorisasi
        sleep 20
        
        # 3. Ambil Tailscale IP dari log container (Pastikan entrypoint.sh sukses)
        TAILSCALE_IP=$(docker exec vnc-runner tailscale ip -4)
        NOVNC_PORT=6080 # Port yang terekspos di Dockerfile

        # Output sebagai notifikasi dan sebagai output job
        echo "::notice file=README.md,line=1::Akses Desktop (dari Tailnet Anda) di: http://$TAILSCALE_IP:$NOVNC_PORT/vnc.html"
        
        # Menyimpan IP sebagai output langkah, berguna untuk langkah berikutnya jika ada
        echo "tailscale_ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT

    # 4. (OPSIONAL) Langkah CI/CD Utama
    # Setelah container berjalan, Anda dapat melakukan tugas CI/CD di sini,
    # misalnya menjalankan build di dalam container VNC:
    - name: ‚öôÔ∏è Execute Primary Build Task
      run: |
        echo "Menjalankan task Gradle di dalam container..."
        # Asumsi 'gass' atau './gradlew' ada di path proyek di dalam container
        docker exec vnc-runner /bin/bash -c "cd /home/developer/botklik && ./gradlew clean assembleDebug"
        
    # 5. BERTAHAN AGAR BISA DIAKSES REMOTE (Wajib untuk sesi RDP/VNC)
    # Langkah ini akan menahan job agar tidak selesai. Anda harus membatalkannya secara manual!
    - name: ‚è≥ Hold Runner for Manual VNC Access (1 Hour)
      run: sleep 3600 # 3600 detik = 1 jam

    # 6. CLEANUP DAN STOP CONTAINER
    - name: üõë Stop Container
      # Gunakan 'if: always()' untuk memastikan container dihentikan meskipun job gagal
      if: always()
      run: |
        echo "Menghentikan container untuk menyimpan Volume..."
        docker stop vnc-runner
        
    # 7. SAVE DOCKER VOLUME CACHE
    - name: üíæ Save Docker Volume Cache
      uses: actions/cache@v4
      # Hanya simpan cache jika cache di awal adalah 'MISS'
      if: steps.cache-restore.outputs.cache-hit != 'true'
      with:
        path: /var/lib/docker/volumes/
        key: ${{ runner.os }}-docker-volume-v1-${{ hashFiles('Dockerfile') }}
