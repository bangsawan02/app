# .github/workflows/setup-gui-runner.yml

name: setup KDE Plasma + Tailscale + VNC/NoVNC

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      TAILSCALE_AUTHKEY: ${{ vars.AUTHKEY }} # Harus disetel sebagai GitHub Variable/Secret
      USERNAME: runner
      PASSWORD: runner
      VNC_DISPLAY: ':1' 
      VNC_PORT: 5901   
      NOVNC_PORT: 6080 
      
      # Gunakan Run ID di hostname agar unik
      TAILSCALE_HOSTNAME: gh-plasma-${{ github.run_id }} 

    steps:
      - uses: actions/checkout@v4

      - name: Setup User Password
        run: |
          # Buat pengguna runner jika belum ada dan setel sandi
          sudo useradd -m -s /bin/bash ${USERNAME} || echo "User ${USERNAME} already exists."
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}
          
      - name: Install Desktop, VNC Server, dan NoVNC
        run: |
          echo ">>> Installing Desktop & VNC components..."
          sudo apt-get update -qq
          # Instal KDE, VNC Server, dan utilitas pendukung
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq kde-plasma-desktop tightvncserver xterm websockify net-tools 
          
          # Unduh dan Instal NoVNC
          mkdir -p /home/${USERNAME}/novnc
          cd /home/${USERNAME}/novnc
          # Menggunakan versi stabil
          wget https://github.com/novnc/noVNC/archive/refs/tags/v1.3.0.tar.gz
          tar -xzvf v1.3.0.tar.gz > /dev/null
          mv noVNC-1.3.0 www
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/novnc
          
      - name: Configure and Start VNC Server
        run: |
          # Switch ke user runner untuk konfigurasi VNC
          sudo -H -u ${USERNAME} bash -c "
            # Setel sandi VNC
            echo \"${PASSWORD}\" | vncpasswd -f > /home/${USERNAME}/.vnc/passwd
            chmod 600 /home/${USERNAME}/.vnc/passwd
            
            # Konfigurasi xstartup untuk memulai KDE
            mkdir -p /home/${USERNAME}/.vnc
            echo '#!/bin/sh' > /home/${USERNAME}/.vnc/xstartup
            echo 'xrdb /home/${USERNAME}/.Xresources' >> /home/${USERNAME}/.vnc/xstartup
            echo 'startkde' >> /home/${USERNAME}/.vnc/xstartup
            chmod +x /home/${USERNAME}/.vnc/xstartup
            
            # Start VNC Server di background
            vncserver ${VNC_DISPLAY} -geometry 1280x800 -depth 24
          "
          
      - name: Install Tailscale dan Dapatkan IP
        id: tailscale_setup
        run: |
          echo ">>> Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh >/dev/null 2>&1
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "${TAILSCALE_HOSTNAME}"

          # Dapatkan IP Tailscale dan setel sebagai variabel lingkungan
          TAILSCALE_IP=$(sudo tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          
          # Baris KRUSIAL untuk diekstrak oleh aplikasi Android (Marker)
          echo "TAILSCALE_IP_OUTPUT::${TAILSCALE_IP}" 
          
      - name: Start NoVNC Web Server dan Keep Alive
        run: |
          echo "=== FINAL CONNECTION INFO ==="
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "NoVNC URL: http://${{ env.TAILSCALE_IP }}:${NOVNC_PORT}/vnc.html"
          echo "VNC Password: ${PASSWORD}"

          # Start NoVNC Web Server di background, meneruskan koneksi dari 6080 ke VNC 5901
          sudo -H -u ${USERNAME} bash -c "
             /usr/bin/websockify ${NOVNC_PORT} localhost:${VNC_PORT} > /home/${USERNAME}/novnc.log 2>&1 &
          "
          
          echo ">>> Runner aktif selama 6 jam. Connect now via Android WebView."
          # Tahan runner selama 6 jam (batas maksimal GitHub)
          sleep 21600 || true
